%%%
%%%               ejabberd configuration file
%%%
%%%'

%%% The parameters used in this configuration file are explained in more detail
%%% in the ejabberd Installation and Operation Guide.
%%% Please consult the Guide in case of doubts, it is included with
%%% your copy of ejabberd, and is also available online at
%%% http://www.process-one.net/en/ejabberd/docs/

%%%.   =========
%%%'   DEBUGGING

%%
%% loglevel: Verbosity of log files generated by ejabberd.
%% 0: No ejabberd log at all (not recommended)
%% 1: Critical
%% 2: Error
%% 3: Warning
%% 4: Info
%% 5: Debug
%%
{loglevel, 5}.

%%%.   ================
%%%'   SERVED HOSTNAMES

%%
%% hosts: Domains served by ejabberd.
%% You can define one or several, for example:
%% {hosts, ["example.net", "example.com", "example.org"]}.
%%
{hosts, ["localhost", "bonga.ke", "qa.bonga.ke", "preprod.bonga.ke"] }.

%%
%% route_subdomains: Delegate subdomains to other XMPP servers.
%% For example, if this ejabberd serves example.org and you want
%% to allow communication with an XMPP server called im.example.org.
%%
%%{route_subdomains, s2s}.


%%%.   ===============
%%%'   LISTENING PORTS
%%
%% listen: The ports ejabberd will listen on, which service each is handled
%% by and what options to start it with.
%%
{listen,
  [
    {5222, ejabberd_c2s, [
      verify_peer,
      starttls,
      starttls_required,
      {access, c2s},
      {shaper, c2s_shaper},
      {max_stanza_size, 65536},
      {protocol_options, ["no_sslv3"]},
      % server's cert file (with unencrypted server's key in pem format)
      {certfile, "/etc/cert-key-secret/cert_and_key.pem"},
      % root CA cert file, required for client's certificate validation
      {cafile, "/etc/cert-key-secret/ca-chain.pem"}
    ]},

    %% ejabberd_service: Interact with external components (transports, ...)
    {8888, ejabberd_service, [
      {access, all},
      {hosts, ["mpesa.localhost","rosaline.localhost"], [{password, "MPESA_PSWD"}]},
      {password, "MPESA_PSWD"}
    ]}
    
  ]
}.

%%%.   ==============
%%%'   SESSION BACKEND
{sm_backend, {mnesia, []} }.


%%%.   ==============
%%%'   AUTHENTICATION
{auth_method, [http]}.


{auth_opts, [
  {password_format, AUTH_PASSWORD_FORMAT},
  {basic_auth, "mim_node_1:mim_node1"},
  {cyrsasl_external, use_common_name}
]}.

{sasl_mechanisms, [cyrsasl_external, cyrsasl_scram, cyrsasl_plain, cyrsasl_digest, cyrsasl_scram ]}.

%%%.   ==============
%%%'   DATABASE SETUP


%% More examples that may be added to outgoing_pools list:
%%
%% == MySQL ==
{rdbms_server_type, mysql}.
{outgoing_pools, [
    {rdbms, global, default, [{workers, 10}],
      [{server, {mysql, "MYSQL_DB_HOST", 3306, "MYSQL_DB_NAME", "MYSQL_DB_USERNAME", "MYSQL_DB_PASSWORD"}},
      {keepalive_interval, 10}]},
      {http, global, mongoose_push_http, [{workers, 10}], [{server, "MONGOOSE_PUSH_SERVER"}]},
      {http, global, auth, [{workers, 5}], [{server, "AUTH_HOST"}, {path_prefix, "/mim/"}]}

    
  ]}.
%% keepalive_interval is optional





%%%.   ===============
%%%'   TRAFFIC SHAPERS

%%
%% The "normal" shaper limits traffic speed to 1000 B/s
%%
{shaper, normal, {maxrate, 1000}}.

%%
%% The "fast" shaper limits traffic speed to 50000 B/s
%%
{shaper, fast, {maxrate, 50000}}.

%%
%% This option specifies the maximum number of elements in the queue
%% of the FSM. Refer to the documentation for details.
%%
{max_fsm_queue, 1000}.

%%%.   ====================
%%%'   ACCESS CONTROL LISTS

%% Local users: don't modify this line.
{acl, local, {user_regexp, ""}}.

%%%.   ============
%%%'   ACCESS RULES

%% Maximum number of simultaneous sessions allowed for a single user:
{access, max_user_sessions, [{10, all}]}.

%% Maximum number of offline messages that users can have:
{access, max_user_offline_messages, [{5000, admin}, {100, all}]}.

%% This rule allows access only for local users:
{access, local, [{allow, local}]}.

%% Only non-blocked users can use c2s connections:
{access, c2s, [{deny, blocked},
	       {allow, all}]}.

%% For C2S connections, all users except admins use the "normal" shaper
{access, c2s_shaper, [{none, admin}, {none, all}]}.

%% Admins of this server are also admins of the MUC service:
{access, muc_admin, [{allow, admin}]}.

%% Only accounts of the local ejabberd server can create rooms:
{access, muc_create, [{allow, local}]}.

%% All users are allowed to use the MUC service:
{access, muc, [{allow, all}]}.


%% By default the frequency of account registrations from the same IP
%% is limited to 1 account every 10 minutes. To disable, specify: infinity
{registration_timeout, infinity}.

%% Default settings for MAM.
%% To set non-standard value, replace 'default' with 'allow' or 'deny'.
%% Only user can access his/her archive by default.
%% An online user can read room's archive by default.
%% Only an owner can change settings and purge messages by default.
%% Empty list (i.e. `[]`) means `[{deny, all}]`.
{access, mam_set_prefs, [{default, all}]}.
{access, mam_get_prefs, [{default, all}]}.
{access, mam_lookup_messages, [{default, all}]}.
{access, mam_purge_single_message, [{default, all}]}.
{access, mam_purge_multiple_messages, [{default, all}]}.
%% 1 command of the specified type per second.
{shaper, mam_shaper, {maxrate, 1}}.
%% This shaper is primeraly for Mnesia overload protection during stress testing.
%% The limit is 1000 operations of each type per second.
{shaper, mam_global_shaper, {maxrate, 1000}}.
{access, mam_set_prefs_shaper, [{mam_shaper, all}]}.
{access, mam_get_prefs_shaper, [{mam_shaper, all}]}.
{access, mam_lookup_messages_shaper, [{mam_shaper, all}]}.
{access, mam_purge_single_message_shaper, [{mam_shaper, all}]}.
{access, mam_purge_multiple_messages_shaper, [{mam_shaper, all}]}.
{access, mam_set_prefs_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_get_prefs_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_lookup_messages_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_purge_single_message_global_shaper, [{mam_global_shaper, all}]}.
{access, mam_purge_multiple_messages_global_shaper, [{mam_global_shaper, all}]}.

%%%.   ================
%%%'   DEFAULT LANGUAGE
{language, "en"}.

%%%.   ================
%%%'   MISCELLANEOUS
{all_metrics_are_global, false }.

%%%.   =======
%%%'   MODULES
%% Modules enabled in all ejabberd virtual hosts.
%% For list of possible modules options, check documentation.

{modules,
 [
 

                            
  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_ping/
  {mod_ping, [
    {send_pings, true},
    {ping_interval, 60},
    {timeout_action, kill}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_disco/
  {mod_disco, [{iqdisc, parallel}]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_last/
  {mod_last, [
    {backend, rdbms}
  ]},

  %% http://mongooseim.readthedocs.io/en/latest/modules/mod_stream_management/
  {mod_stream_management, [
    % size of a buffer of unacked messages
    {buffer_max, 100},

    % default 1 - server sends the ack request after each stanza
    {ack_freq, 1},

    % default: 600 seconds
    {resume_timeout, 60}
  ]},

  %% http://mongooseim.readthedocs.io/en/latest/modules/mod_muc_light/
  {mod_muc_light, [
    {rooms_per_page, 10},
    {backend, rdbms},
    {host, "muclight.@HOST@"},
    {config_schema, ["roomname", "subject", "avatar", "creationDate"]},
    {default_config, [{"roomname", "Bonga Group Chat"}, {"subject", ""}, {"avatar", ""}, {"creationDate", ""}]}
  ]},

  %% http://mongooseim.readthedocs.io/en/latest/modules/mod_offline_stub/
  {mod_offline_stub, []},

  %% http://mongooseim.readthedocs.io/en/latest/modules/mod_caps/
  {mod_caps, [
    {cache_size, 10000}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_pubsub/
  {mod_pubsub, [
    {access_create,all},
    {ignore_pep_from_offline, true},
    {last_item_cache, mnesia},
    {max_items_node, 100000}, 
    {plugins, [<<"pep">>, <<"push">>]}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_push_service_mongoosepush/
  {mod_push_service_mongoosepush, [
    {pool_name, mongoose_push_http},
    {api_version, "v2"}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_private/
  {mod_private, [
    {backend, rdbms}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_roster/
  {mod_roster, [
    {backend, rdbms}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_vcard/
  {mod_vcard, [
    {host, "vjud.@HOST@"},
    {backend, rdbms}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_carboncopy/
  {mod_carboncopy, []},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_mam/
  {mod_mam_meta, [
    {backend, rdbms},
    {rdbms_message_format, simple},
    {pm, [
      {user_prefs_store, mnesia}
    ]}
  ]},

  %% https://mongooseim.readthedocs.io/en/latest/modules/mod_event_pusher/
  {mod_event_pusher, [
    {backends, [
      {push, [
        {wpool, [{workers, 100}]}
      ]}
    ]}
  ]}
]}.